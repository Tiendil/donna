
# FSM Driven Development

Your agent will generate [state machines](https://en.wikipedia.org/wiki/Finite-state_machine) while executing state machines that are generated by state machines.

## What is Donna?

Donna is a CLI tool that helps coding agents like Codex to behave deterministically and focus on the perfomed work.

It is designed to invert control flow: instead of agent deciding what to do and in which order, Donna dictates what should be done on each step of work, so the agent can focus on the actual piece of work.

However, Donna is not an orchestrator, it is a tool to be used by agent, so, it can be used with any agent and does not require API keys or any other credentials. You may look at a donna like on the work diary or personal secretary for your agent.

The core idea:

- **Most high-level work are more algorithmic than it may seem at first glance.**
- **Most low-level workf are less algorithmic than it may seem at first glance.**

For example, it may be non-trivial to fix a particular unit test, but the overall process of polishing the codebase is quite linear:

1. Ensure all tests pass.
2. Ensure the code is formatted correctly.
3. Ensure there are no linting errors.
4. Go to the step 1 if you changed something in the process.
5. Finish.

Coding agents show greate results on each separate step of the process, however they often struggle to manage meta-loops in deterministic maner — they forget steps, misinterpret results, use wrong ways to run tools, etc.

So, Donna executes such loops for the agents and therefore saves time, context and tokens simultaneously increasing the overall quality of work.

## Features

- **Deterministic workflows** — fixed & validated control flows.
- **Saves context, tokens and time** — agents do not need to think when thinking is not required.
- **Readable artifacts** — all workflows and specifications are pure Markdown files with some [Jinja2](https://github.com/pallets/jinja) templating.
- **Artifact management** — non-fuzzy navigation and smart agent-focused rendering of specs.
- **Artifact distribution** — install your docs/workflows/skills as (with) your Python package.
- **Agent-centric behavior** with clear instructions, suggestions on fixing mistakes.
- **Extensible architecture** — implement your own operations, validators, renderers; add support for new artifact formats and storages (worlds).
- **Batteries included** — Donna goes with a set of pre-defined workflows, so you can start using it right away.

## Example

Donna is developed via Donna itself. So, you can find real life examples of workflows and specifications in the [.donna/project](./.donna/project) folder of this repository.

The example below is a simplified version of the polishing workflow that formats code, runs linters and fixes found problems untill all checks pass. It uses the single operaton type `donna.lib.request_action` to ask the agent to perform specific instructions.

```
                                no issues
[ run_black ] ──▶ [ run_mypy ] ───────────▶ [ finish ]
      ▲                │
      │  issues fixed  │
      └────────────────┘
```

<details>
<summary><strong>Example of a simple workflow</strong></summary>

~~~
# Polishing Workflow

```toml donna
kind = "donna.lib.workflow"
start_operation_id = "run_black"
```

Initiate operations to polish and refine the codebase: …

## Run Black

```toml donna
id = "run_black"
kind = "donna.lib.request_action"
```

1. Run `black .` to format the codebase.
2. `{{ goto("run_mypy") }}`

## Run Mypy

```toml donna
id = "run_mypy"
kind = "donna.lib.request_action"
```

1. Run `mypy .` to check the codebase for type annotation issues.
2. If there are issues found that you can fix, fix them.
3. Ask developer to fix any remaining issues manually.
4. If you made changes `{{ goto("run_black") }}`.
5. If no issues are found `{{ goto("finish") }}`.

## Finish

```toml donna
id = "finish"
kind = "donna.lib.finish"
```

Polishing is complete.
~~~
</details>

What you may notice:

1. The workflow has a loop.
2. The workflow is a Markdown file.
3. Each h1 and h2 section has a config block which is a TOML in code fences with `donna` marker. Those configs are invisible to the agent, but Donna uses them to understand the artifact structure.
4. The workflow has two `donna.lib.request_action` operations (`run_black`, `run_mypy`) and one `donna.lib.finish` (`finish`).
5. Transitions between operations are defined via `{{ goto("operation_id") }}` Jinja2 calls in the body of operations.
6. `donna.lib.request_action` is an operation that tells Donna to display instructions to the agent and wait for the agent to complete them. That allows agent to focus on short precise intructions, perform them and push workflow forward.
7. `kind` attributes of sections are valid Python import paths, so you can easily extend Donna with your own logic.

Directives, like `{{ goto("operation_id") }}`, render itself depending on the context:

- For the agent they render an exect CLI command to run, such as `donna -p llm sessions action-request-completed <action-request-id> 'artifact_id:operation_id'`.
- For Donna they render a specific marker, that can be extracted and used to analyze an artifact. For example, Donna uses `goto` directives to build a FSM model of the workflow and validate it before running: does each operation exist, is there a way to finish the workflow, are there unreachable operations, etc.

You can find a more complex implementaion of the same workflow in the [polish.md](./.donna/project/work/polish.md) file. It demonstrates other Donna operations such as running the scripts directly, branching, etc.

## Installation

1. Install `donna` package.

```bash
pip install donna

cd <your-project-root>
donna -p human workspaces init
```

2. Add short instruction into your `AGENT.md` file.

```markdown
**Use `donna` tool to work on this project.**

**ALWAYS** run `donna -p llm artifacts view '*:intro'` when you start working on the projct. It **MUST** be a one time operation. Do not repeat it unless you forget how to use the tool.
```

## Usage

**Donna is a CLI tool for agents.** You rarery need to use it directly.

Use `donna --help` if you need a quick reference.

You find detailed documentation in the agent instructions — they are readable and always accurate:

- [Full CLI specification](./donna/artifacts/usage/cli.md) — full list of commands and how to use them.
- [Artifacts](./donna/artifacts/usage/artifacts.md) — what is Donna artifact and how to use them.
- [Worlds](./donna/artifacts/usage/worlds.md) — how Donna discovers and manages its artifacts.

The documentation below covers aspects that are important for Humans and partially duplicates the agent instructions.

## Batteries Included

Donna comes with a set of pre-defined workflows and specifications that empower agents to work in a Donna way.

However, **I encourage you to experiment and implement your own workflows**.

By default, Donna uses the next approach to introduce changes in your project:

1. Prepare a Request for Comments (RFC) document that describes the required changes.
2. Create a workflow that implements the changes described in the RFC.
3. Execute new workflow.

Additionaly, Donna will:

- choose fast or slow route depending on the complexity of the changes required;
- find and run polishing workflow to ensure the codebase is in a good state after the changes;
- find and run workflow to update your changelog.

Points of interests:

- [donna:rfc:specs:request_for_change](./donna/artifacts/rfc/specs/request_for_change.md) — specification of the RFC document.
- [donna:rfc:work:create](./donna/artifacts/rfc/work/create.md) — workflow to create a RFC document.
- [donna:rfc:work:plan](./donna/artifacts/rfc/work/plan.md) — workflow to plan work on a RFC — creates a new workflow.
- [donna:rfc:work:do](./donna/artifacts/rfc/work/do.md) — meta workflow to automate the whole way from a developer request to a changelog update.

## Artifacts and Worlds

- Artifacts is something that Donna owns. Currently it is a Markdown files with workflows and specifications.
- World is a storage for artifacts. Currently, Donna supports two types of worlds:
    - `donna.lib.worlds.filesystem` — a folder on the filesystem.
    - `donna.lib.worlds.python` — a Python package subfolder.

**Please, tell if you need other world types.** It looks interesting to have `http`, `s3`, `git`, `sql` worlds.

By default, Donna uses the next worlds:

- `donna` — artifacts provided by Donna itself;
- `home` — user-level donna artifacts in `<HOME>/.donna/` folder;
- `project` — project-level donna artifacts in `<project-root>/.donna/project/` folder;
- `session` — session-level donna artifacts in `<project-root>/.donna/session/` folder.

Besides that, there is `<project-root>/.donna/tmp` folder used to store temporary files.


## Sessions

## Workflows

### Operations

### Error handling

## Specifications

## Extending Donna

## Distribute Your Artifacts
